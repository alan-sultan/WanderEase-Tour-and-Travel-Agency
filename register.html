<?php
// filepath: c:\Users\ahmed\2nd Semister php project\WanderEase-Tour-and-Travel-Agency-main\Backend\register.php

session_start();
require_once '../config.php'; // Include your database connection file
require_once 'sanitize.php'; // Include sanitization functions
require_once 'User.php'; // Include the User class

// Check if the form is submitted
if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    // Validate CSRF token
    if (!isset($_POST['csrf_token']) || $_POST['csrf_token'] !== $_SESSION['csrf_token']) {
        $_SESSION['error'] = 'Invalid CSRF token.';
        header('Location: ../register.html');
        exit;
    }

    // Retrieve and sanitize form data
    $username = sanitizeString($_POST['username']);
    $email = sanitizeEmail($_POST['email']);
    $password = sanitizePassword($_POST['password']);
    $confirm_password = sanitizePassword($_POST['confirm_password']);

    // Validate input
    if (empty($username) || empty($email) || empty($password) || empty($confirm_password)) {
        $_SESSION['error'] = 'Please fill in all fields.';
        header('Location: ../register.html');
        exit;
    }

    if ($password !== $confirm_password) {
        $_SESSION['error'] = 'Passwords do not match.';
        header('Location: ../register.html');
        exit;
    }

    if (strlen($password) < 8) {
        $_SESSION['error'] = 'Password must be at least 8 characters long.';
        header('Location: ../register.html');
        exit;
    }

    // Use the User class to handle registration
    $userModel = new User($conn);
    $result = $userModel->register($username, $email, $password);

    if ($result['status'] === 'success') {
        $_SESSION['success'] = $result['message'];
        header('Location: ../login.html');
        exit;
    } else {
        $_SESSION['error'] = $result['message'];
        header('Location: ../register.html');
        exit;
    }
}
?>
